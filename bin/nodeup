#!/usr/bin/env ruby
require 'pathname'
ENV['BUNDLE_GEMFILE'] ||= File.expand_path('../../Gemfile', Pathname.new(__FILE__).realpath)
require 'bundler/setup'

require 'chef/config'
require 'simple_config'
require 'node'

env_file = 'env.parameters'
File.delete env_file if File.exist? env_file

nodes = []
threads = []
SimpleConfig.deploy.count.to_i.times do
  node = Node.new
  threads << Thread.new do
    node.create SimpleConfig.deploy
    nodes.push node
    node.delete if !node.status && !SimpleConfig.deploy.save
  end
end
threads.each(&:join)

deployed = nodes.select(&:status)
rejected = nodes.reject(&:status)

puts 'Bootstrapped the following nodes:'.green if deployed.any?
deployed.each { |node| puts node.name.green }

puts 'Failed the following nodes:'.red if rejected.any?
rejected.each do |node|
  puts node.name.red
  puts node.output
end

exit 1 if rejected.any?
