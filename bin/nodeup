#!/usr/bin/env ruby
require 'bundler/setup'
require 'chef/config'
require 'simple_config'
require 'node'

Chef::Config[:node_name] = 'docker-ci-runner'
Chef::Config[:client_key] = SimpleConfig.chef.apikey
Chef::Config[:chef_server_url] = SimpleConfig.chef.url
Chef::Config[:knife][:linode_api_key] = SimpleConfig.linode.apikey
Chef::Config[:knife][:environment] = SimpleConfig.deploy.chef.env
Chef::Config[:knife][:yes] = ''

nodes = []
threads = []
SimpleConfig.deploy.count.to_i.times do
  node = Node.new
  threads << Thread.new do
    node.create SimpleConfig.deploy
    nodes.push node
  end
end
threads.each(&:join)

deployed = nodes.select(&:status)
rejected = nodes.reject(&:status)

if deployed.any?
  puts 'Bootstrapped the following nodes:'.green
  deployed.each do |node|
    puts node.name.green
  end
end

if rejected.any?
  puts 'Failed the following nodes:'.red
  rejected.each do |node|
    puts node.name.red
  end
  File.write('nodedown.parameters', "nodes=#{rejected.map(&:name).join(' ')}") unless SimpleConfig.deploy.save
end

exit 1 if nodes.reject(&:status).any?
